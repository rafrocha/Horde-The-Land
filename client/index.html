<div id="signDiv">
  Username: <input id="signDiv-username" type="text"></input><br>
  Password: <input id="signDiv-password" type="password"></input>
  <button id="signDiv-signIn">Sign In</button>
  <button id="signDiv-signUp">Sign Up</button>
</div>


<div id="gameDiv" style="display:none;">

  <div id="game" style="position:absolute;width:500px;height:100px;">
    <canvas id="ctx" width="500" height="500" style="position:absolute;border:1px solid #000000;"></canvas>
    <canvas id="ctx-ui" width="500" height="500" style="position:absolute;border:1px solid #000000;"></canvas>

    <div id="ui" style="position:absolute;width:500px;height:500px;">
      <button onclick="changeMap()" style="position:absolute;bottom: 0px;left:0px">
        Change Map
      </button>

    </div>

  </div>

  <div id="belowGame" style="margin-top:520px;">
    <div id="chat-text" style="width:500px;height:100px;overflow-y:scroll">
      <div>First MSG</div>
    </div>

    <form id="chat-form">
      <input id="chat-input" type="text" style="width:500px"></input>
    </form>
  </div>

</div>

<script src="https://cdn.socket.io/socket.io-1.4.5.js"></script>
<script>
  const WIDTH = 500;
  const HEIGHT = 500;
  const socket = io();

  //sign
  let signDiv = document.getElementById('signDiv');
  let signDivUsername = document.getElementById('signDiv-username');
  let signDivSignIn = document.getElementById('signDiv-signIn');
  let signDivSignUp = document.getElementById('signDiv-signUp');
  let signDivPassword = document.getElementById('signDiv-password');
  let gameDiv = document.getElementById('gameDiv');ï»¿

  signDivSignIn.onclick = function(){
    socket.emit('signIn', {username:signDivUsername.value,password:signDivPassword.value});
  }

  socket.on('signInResponse', function(data){
    if(data.success){
      signDiv.style.display = 'none';
      gameDiv.style.display = 'inline-block';
    } else {
      alertaw('Sign in unsuccessful.');
    }
  })

    socket.on('addToChat', function(data){
    chatText.innerHTML += `<div>${data}</div>`;
    chatInput.value = '';
  })

  socket.on('evalAnswer', function(data){
    console.log(data);
  });

  let chatText = document.getElementById('chat-text');
  let chatForm = document.getElementById('chat-form');
  let chatInput = document.getElementById('chat-input');


  chatForm.onsubmit = function(e){
    e.preventDefault();
    if(chatInput.value[0] === '/'){
      socket.emit('evalServer', chatInput.value.slice(1));
    } else {
      socket.emit('sendMsgToServer', chatInput.value);
    }
    chatInput.value = '';

  }

  //UI section

  let changeMap = function() {
    socket.emit('changeMap');
  }

  //game stuff

  const skins = ['/client/img/player1.png','/client/img/player2.png']

  const Img = {};
  Img.player = new Image();
  Img.player.src = '/client/img/player1.png';
  Img.bullet = new Image();
  Img.bullet.src = '/client/img/bullet.png';


  const ctx = document.getElementById("ctx").getContext("2d");
  ctx.font = '30px Arial';
  const ctxUi = document.getElementById("ctx-ui").getContext("2d");
  ctxUi.font = '30px Arial';

  const Player = function (initPack) {
    let self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.hp = initPack.hp;
    self.maxHP = initPack.maxHP;
    self.score = initPack.score;
    self.map = initPack.map;
    self.angle = 45;

    self.draw = function() {
      if(Player.list[selfId].map !== self.map){
        return;
      }
      let x = self.x - Player.list[selfId].x + WIDTH/2;
      let y = self.y - Player.list[selfId].y + HEIGHT/2;

      let hpWidth = 40 * self.hp / self.maxHP;
      ctx.fillStyle = 'red';
      ctx.fillRect(x - hpWidth/2, y - 35, hpWidth, 4);

      let width = Img.player.width/1.2;
      let height = Img.player.height/1.5;

      let frameWidth = Img.player.width/3;
      let frameHeight = Img.player.height/3.9;

      let directionMod = 3;
      let angle = Player.list[selfId].angle;

      if(angle < 0)
        angle = 360 + angle;

      if(angle >= 45 && angle < 135 )
        directionMod = 2;
      else if(angle >= 135 && angle < 225 )
        directionMod = 1;
      else if(angle >= 225 && angle < 315 )
        directionMod = 0;

      ctx.drawImage(Img.player,0,directionMod*frameHeight,frameWidth,frameHeight, x-width/2,y-height/2,width,height);

    }

    Player.list[self.id] = self;

    return self;
  }

  Player.list = {};

  const Bullet = function (initPack) {
    let self = {};
    self.id = initPack.id;
    self.number = initPack.number;
    self.x = initPack.x;
    self.y = initPack.y;
    self.map = initPack.map;

    self.draw = function() {
      if(Player.list[selfId].map !== self.map){
        return;
      }
      let width = Img.bullet.width/2;
      let height = Img.bullet.height/2;

      let x = self.x - Player.list[selfId].x + WIDTH/2;
      let y = self.y - Player.list[selfId].y + HEIGHT/2;


      ctx.drawImage(Img.bullet,0,0,Img.bullet.width,Img.bullet.height, x-width/2,y-height/2,width,height);
    }

    Bullet.list[self.id] = self;
    return self;
  }

  Bullet.list = {};

  let selfId = null;

  socket.on('init', function(data){
    if(data.selfId){
      selfId = data.selfId;
    }
    for(let i = 0; i < data.player.length; i++){
      new Player(data.player[i]);
    }
    for(let i = 0; i < data.bullet.length; i++){
      new Bullet(data.bullet[i]);
    }
  });

  socket.on('update', function(data){
    for(let i = 0; i < data.player.length; i++){
      let pack = data.player[i];
      let p = Player.list[pack.id];
      if (p) {
        if (pack.x !== undefined)
          p.x = pack.x;
        if (pack.y !== undefined)
          p.y = pack.y;
        if (pack.hp !== undefined)
          p.hp = pack.hp;
        if (pack.score !== undefined)
          p.score = pack.score;
        if (pack.map !== undefined)
          p.map = pack.map;
      }
    }

    for(let i = 0; i < data.bullet.length; i++){
      let pack = data.bullet[i];
      let b = Bullet.list[pack.id];
      if (b) {
        if (pack.x !== undefined)
          b.x = pack.x
        if (pack.y !== undefined)
          b.y = pack.y
      }
    }
  });

  socket.on('remove', function(data){
    for(let i = 0; i < data.player.length; i++){
      delete Player.list[data.player[i]];
    }
    for(let i = 0; i < data.bullet.length; i++){
      delete Bullet.list[data.bullet[i]];
    }
  });

  setInterval(function () {
    if(!selfId)
      return;
    ctx.clearRect(0,0,500,500);
    currentMap.draw();
    drawScore();
    for(let i in Player.list){
      Player.list[i].draw();
    }

    for(let i in Bullet.list){
      Bullet.list[i].draw();
    }
 },40);


  const Maps = function(id, imgSrc, width, height) {
    let self = {
      id:id,
      image: new Image(),
      width: width,
      height: height
    }
    self.image.src = imgSrc;

    self.draw = function() {
      let player = Player.list[selfId];
      let x = WIDTH/2 - player.x;
      let y = HEIGHT/2 - player.y;
      ctx.drawImage(self.image,0,0,self.image.width,self.image.height,x,y,self.image.width*2,self.image.height*2);
    }
    return self;
  }


  currentMap = Maps('field','/client/img/map.png',1280,960);
  Img.map = {};
  Img.map['field'] = new Image();
  Img.map['field'].src = '/client/img/map.png';
  Img.map['forest'] = new Image();
  Img.map['forest'].src = '/client/img/map2.png';




  const drawScore = function() {
    if(lastScore === Player.list[selfId].score){
      return;
    }
    ctxUi.clearRect(0,0,500,500);
    lastScore = Player.list[selfId].score;
    ctxUi.fillStyle = 'white';
    ctxUi.fillText(Player.list[selfId].score,0,30);
  }

  let lastScore = null;

  document.onkeydown = function (event){
    if(event.keyCode === 68) //d
      socket.emit('keyPress', {inputId: 'right', state:true});
    else if(event.keyCode === 83) //s
      socket.emit('keyPress', {inputId: 'down', state:true});
    else if(event.keyCode === 65) //a
      socket.emit('keyPress', {inputId: 'left', state:true});
    else if(event.keyCode === 87) //w
      socket.emit('keyPress', {inputId: 'up', state:true});
  }

  document.onkeyup = function (event){
    if(event.keyCode === 68) //d
      socket.emit('keyPress', {inputId: 'right', state:false});
    else if(event.keyCode === 83) //s
      socket.emit('keyPress', {inputId: 'down', state:false});
    else if(event.keyCode === 65) //a
      socket.emit('keyPress', {inputId: 'left', state:false});
    else if(event.keyCode === 87) //w
      socket.emit('keyPress', {inputId: 'up', state:false});
  }

  document.onmousedown = function(event){
    socket.emit('keyPress', {inputId: 'attack', state:true});
  }

  document.onmouseup = function(event){
    socket.emit('keyPress', {inputId: 'attack', state:false});
  }

  document.onmousemove = function(event){
    let x = -250 + event.clientX - 8;
    let y = -250 + event.clientY - 8;
    let angle = Math.atan2(y,x) / Math.PI * 180;
    Player.list[selfId].angle = angle;
    socket.emit('keyPress', {inputId: 'mouseAngle', state:angle});
  }

</script>


